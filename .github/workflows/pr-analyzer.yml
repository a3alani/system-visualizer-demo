name: PR Analyzer

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  analyze:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Install Ruby
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y ruby
        ruby --version
        which ruby
    
    - name: Execute System Visualizer
      run: |
        chmod +x bin/system_visualizer
        ls -la bin/system_visualizer
        ./bin/system_visualizer pr main
    
    - name: Show generated files
      run: |
        ls -la docs/system-diagrams/ || echo "No diagrams directory"
        cat docs/system-diagrams/pr-changes.md || echo "No PR changes file"
    
    - name: Post PR Comment
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          try {
            const diagramPath = 'docs/system-diagrams/pr-changes.md';
            if (fs.existsSync(diagramPath)) {
              const diagram = fs.readFileSync(diagramPath, 'utf8');
              const comment = \`## üîç System Impact Analysis

\\\`\\\`\\\`mermaid
\${diagram}
\\\`\\\`\\\`

**Generated by System Visualizer** - Shows the impact of your changes on the codebase architecture.\`;
              
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            } else {
              console.log('No PR diagram was generated');
            }
          } catch (error) {
            console.log('Error creating comment:', error);
          }
